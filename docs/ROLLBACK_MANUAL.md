–ü—Ä–µ–∫—Ä–∞—Å–Ω–æ üíæ
–í–æ—Ç –∑–∞–≤–µ—Ä—à–∞—é—â–∏–π –¥–æ–∫—É–º–µ–Ω—Ç ‚Äî **`docs/ROLLBACK_MANUAL.md`**,
–≤ –∫–æ—Ç–æ—Ä–æ–º –ø–æ–¥—Ä–æ–±–Ω–æ –æ–ø–∏—Å–∞–Ω–æ, –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω—ã–π **–æ—Ç–∫–∞—Ç –≤–µ—Ä—Å–∏–∏ (rollback)**
–≤ –ø—Ä–æ–µ–∫—Ç–µ **Legal Assistant Arbitrage v2.4**.

–û–Ω –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è DevOps-–∏–Ω–∂–µ–Ω–µ—Ä–æ–≤ –∏ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤,
—á—Ç–æ–±—ã –≤ —Å–ª—É—á–∞–µ —Å–±–æ—è –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω–µ –º–æ–∂–Ω–æ –±—ã–ª–æ –±—ã—Å—Ç—Ä–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–∞–±–æ—á–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

---

````markdown
# üîÑ ROLLBACK MANUAL ‚Äî Legal Assistant Arbitrage v2.4

## üìò –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –ø—Ä–æ—Ü–µ–¥—É—Ä—ã **–æ—Ç–∫–∞—Ç–∞ –≤–µ—Ä—Å–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è**, **–±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö** –∏ **Docker-–æ–±—Ä–∞–∑–æ–≤**
–¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ **Legal Assistant Arbitrage v2.4**.
–û—Ç–∫–∞—Ç –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è, –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –º–∏–≥—Ä–∞—Ü–∏—è—Ö –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö –≤ CI/CD –ø–∞–π–ø–ª–∞–π–Ω–µ.

---

## ‚ö†Ô∏è 1. –ö–æ–≥–¥–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è rollback

| –°–∏—Ç—É–∞—Ü–∏—è                            | –ü—Ä–∏–∑–Ω–∞–∫–∏                                      |
| ----------------------------------- | --------------------------------------------- |
| –û—à–∏–±–∫–∞ –¥–µ–ø–ª–æ—è                       | Telegram-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ‚ùå ¬´–û—à–∏–±–∫–∞ –¥–µ–ø–ª–æ—è¬ª       |
| –ù–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–∞—è –º–∏–≥—Ä–∞—Ü–∏—è              | Alembic `upgrade head` –≤—ã–∑—ã–≤–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ    |
| –ü–∞–¥–µ–Ω–∏–µ backend-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞          | `docker logs backend` —Å–æ–¥–µ—Ä–∂–∏—Ç –æ—à–∏–±–∫–∏ –∑–∞–ø—É—Å–∫–∞ |
| API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ                      | `/api/health` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É               |
| Telegram/KAD –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –Ω–µ –ø—Ä–æ—Ö–æ–¥—è—Ç | CI –ø–∞–¥–∞–µ—Ç –Ω–∞ —ç—Ç–∞–ø–µ integration                |

---

## üß† 2. –ü—Ä–∏–Ω—Ü–∏–ø –æ—Ç–∫–∞—Ç–∞

Rollback –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è **–≤ –¥–≤—É—Ö —Å–ª–æ—è—Ö**:

1. **–ö–æ–¥ / Docker-–æ–±—Ä–∞–∑**
   - –æ—Ç–∫–∞—Ç –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É —Ç—ç–≥—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, `v2.3`);
2. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**
   - –æ—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ Alembic –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Ä–µ–≤–∏–∑–∏–∏.

---

## üß± 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ git-–∫–æ–º–º–∏—Ç–∞

```bash
git log -1 --oneline
```
````

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏ Docker-–æ–±—Ä–∞–∑–∞

```bash
docker images | grep legal-assistant-backend
```

–ü—Ä–∏–º–µ—Ä:

```
ghcr.io/aw56/legal-assistant-backend   v2.4   123abc45   2 hours ago
```

---

## üì¶ 4. –û—Ç–∫–∞—Ç –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É Docker-–æ–±—Ä–∞–∑—É

### –ù–∞–π–¥–∏ –Ω—É–∂–Ω—ã–π —Ç—ç–≥

```bash
docker pull ghcr.io/aw56/legal-assistant-backend:v2.3
```

### –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ backend —Å –Ω—É–∂–Ω–æ–π –≤–µ—Ä—Å–∏–µ–π

```bash
docker compose -f docker-compose.prod.yml down
docker compose -f docker-compose.prod.yml up -d --force-recreate --build
```

–∏–ª–∏ –≤—Ä—É—á–Ω—É—é —É–∫–∞–∑–∞–≤ –≤–µ—Ä—Å–∏—é:

```bash
docker run -d --name legal-assistant-backend \
  -p 8080:8080 \
  ghcr.io/aw56/legal-assistant-backend:v2.3
```

---

## üóÑÔ∏è 5. –û—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–π Alembic

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ä–µ–≤–∏–∑–∏–π

```bash
docker compose -f docker-compose.prod.yml exec -T backend alembic history
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â—É—é –º–∏–≥—Ä–∞—Ü–∏—é

```bash
docker compose -f docker-compose.prod.yml exec -T backend alembic current
```

### –û—Ç–∫–∞—Ç–∏—Ç—å –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â—É—é —Ä–µ–≤–∏–∑–∏—é

```bash
docker compose -f docker-compose.prod.yml exec -T backend alembic downgrade -1
```

–∏–ª–∏ —É–∫–∞–∑–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π revision ID:

```bash
docker compose -f docker-compose.prod.yml exec -T backend alembic downgrade <revision_id>
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

```bash
docker compose -f docker-compose.prod.yml exec -T backend alembic current
```

---

## üíæ 6. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏–∑ –±—ç–∫–∞–ø–∞

–ï—Å–ª–∏ –æ—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–ª–æ–º–∞–Ω–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –º–µ–∂–¥—É —Ç–∞–±–ª–∏—Ü–∞–º–∏):

```bash
cat artifacts/db_backup_2025_10_09.sql | docker exec -i legal-assistant-db psql -U admin -d legal_assistant_db
```

–ü–æ—Å–ª–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≥–æ–Ω–∏—Ç–µ smoke-—Ç–µ—Å—Ç:

```bash
make smoke-local
```

---

## üîÅ 7. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –æ—Ç–∫–∞—Ç–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ API

```bash
curl -s http://127.0.0.1:8080/api/health | jq
```

–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:

```json
{ "status": "ok" }
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ Telegram-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

```bash
make telegram-notify-test
```

–û–∂–∏–¥–∞–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ:

> üß© Rollback Test: Telegram connection OK ‚úÖ

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏ backend

```bash
docker exec -it legal-assistant-backend python -c "import backend; print(backend.__version__)"
```

---

## üß∞ 8. –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –æ—Ç–∫–∞—Ç–µ

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:

```bash
python3 backend/app/utils/notify_telegram.py "‚ôªÔ∏è –û—Ç–∫–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω: Legal Assistant Arbitrage v2.4 ‚Üí v2.3 —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à—ë–Ω ‚úÖ"
```

–ï—Å–ª–∏ –æ—Ç–∫–∞—Ç –Ω–µ —É–¥–∞–ª—Å—è:

```bash
python3 backend/app/utils/notify_telegram.py "üö® –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫–∞—Ç–µ –≤–µ—Ä—Å–∏–∏ Legal Assistant Arbitrage ‚Äî —Ç—Ä–µ–±—É–µ—Ç—Å—è –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–æ DevOps ‚ùå"
```

---

## ü©∫ 9. –ü–æ–ª–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π –∞–≤–∞—Ä–∏–π–Ω–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è

```bash
# 1. –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É
ssh -i ~/.ssh/prod_legal_assistant.pem user@server-ip

# 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
docker compose -f docker-compose.prod.yml ps

# 3. –î–µ–ª–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –±—ç–∫–∞–ø
docker exec -t legal-assistant-db pg_dump -U admin legal_assistant_db > artifacts/rollback_backup_$(date +'%Y%m%d_%H%M%S').sql

# 4. –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏
docker compose -f docker-compose.prod.yml exec -T backend alembic downgrade -1

# 5. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º backend –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –æ–±—Ä–∞–∑–µ
docker pull ghcr.io/aw56/legal-assistant-backend:v2.3
docker compose -f docker-compose.prod.yml up -d --force-recreate

# 6. –ü—Ä–æ–≤–µ—Ä—è–µ–º API –∏ Telegram
make smoke-local
make telegram-notify-test
```

---

## üßæ 10. –ß–µ–∫–ª–∏—Å—Ç rollback-–∞

| –≠—Ç–∞–ø                     | –ö–æ–º–∞–Ω–¥–∞                        | –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç           |
| ------------------------ | ------------------------------ | ----------------------------- |
| –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é | `git log -1 --oneline`         | –≤–µ—Ä—Å–∏—è v2.4                   |
| –í—ã–±—Ä–∞—Ç—å –æ–±—Ä–∞–∑            | `docker pull ghcr.io/...:v2.3` | –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ       |
| –û—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–π           | `alembic downgrade -1`         | –º–∏–≥—Ä–∞—Ü–∏—è –æ—Ç–∫–∞—Ç–∞–Ω–∞             |
| Smoke-—Ç–µ—Å—Ç               | `make smoke-local`             | ‚úÖ API –¥–æ—Å—Ç—É–ø–µ–Ω               |
| –ü—Ä–æ–≤–µ—Ä–∫–∞ Telegram        | `make telegram-notify-test`    | —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ          |
| Telegram alert           | `notify_telegram.py`           | —Å–æ–æ–±—â–µ–Ω–∏–µ ‚ÄúRollback –≤—ã–ø–æ–ª–Ω–µ–Ω‚Äù |

---

## üîê 11. –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

- –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–π rollback **–≤ —Å–µ—Ä–µ–¥–∏–Ω–µ –¥–µ–ø–ª–æ—è** ‚Äî –¥–æ–∂–¥–∏—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è CI.
- –ü–æ—Å–ª–µ –æ—Ç–∫–∞—Ç–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–π –±—ç–∫–∞–ø –Ω–æ–≤–æ–π (—Å—Ç–∞—Ä–æ–π) —Å—Ç–∞–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏.
- –ü—Ä–∏ –æ—Ç–∫–∞—Ç–µ –ë–î –≤—Å–µ–≥–¥–∞ —Å–æ—Ö—Ä–∞–Ω—è–π —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –ø–µ—Ä–µ–¥ `downgrade` –∏–ª–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ–º.
- –í—Å–µ rollback-–∏ –¥–æ–ª–∂–Ω—ã —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤ `CHANGELOG.md` –∏–ª–∏ `docs/DEPLOY_LOG.md`.

---

## üß© 12. –ü—Ä–∏–º–µ—Ä —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ rollback-–µ

> ‚ôªÔ∏è **Rollback –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ**
>
> üì¶ –í–µ—Ä—Å–∏—è: `v2.4 ‚Üí v2.3`
> ‚öôÔ∏è –ú–∏–≥—Ä–∞—Ü–∏–∏ –æ—Ç–∫–∞—Ç–∞–Ω—ã
> üåê API –æ—Ç–≤–µ—á–∞–µ—Ç `/health: ok`
> üìÖ –î–∞—Ç–∞: 2025-10-09
> üë§ –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å: `admin@legal-assistant`

---

## ‚úÖ –†–µ–∑—é–º–µ

Rollback –≤ **Legal Assistant Arbitrage v2.4** ‚Äî –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –∏ —É–ø—Ä–∞–≤–ª—è–µ–º—ã–π –ø—Ä–æ—Ü–µ—Å—Å.
–û–Ω –≤–∫–ª—é—á–∞–µ—Ç:

- –æ—Ç–∫–∞—Ç Docker-–æ–±—Ä–∞–∑–∞,
- –æ—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–π Alembic,
- –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ë–î –∏–∑ –±—ç–∫–∞–ø–∞,
- –ø—Ä–æ–≤–µ—Ä–∫—É –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π (Telegram, KAD),
- –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram.

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ—Ç–∫–∞—Ç–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å:

```bash
make doctor
```

—á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å—Ç–∞–±–∏–ª—å–Ω–æ.

---

üõ°Ô∏è **Rollback —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–æ–≤–æ–¥–∏—Ç—å —Ç–æ–ª—å–∫–æ DevOps-–∏–Ω–∂–µ–Ω–µ—Ä—É –∏–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É**,
–ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –ª–∏–¥–∞ –∏–ª–∏ –≤–ª–∞–¥–µ–ª—å—Ü–∞ –ø—Ä–æ–µ–∫—Ç–∞.

```

---

–•–æ—á–µ—à—å, —á—Ç–æ–±—ã —è –ø–æ–¥–≥–æ—Ç–æ–≤–∏–ª –∑–∞–≤–µ—Ä—à–∞—é—â–∏–π —Ñ–∞–π–ª `docs/DEPLOY_LOG_TEMPLATE.md` ‚Äî
—à–∞–±–ª–æ–Ω –∂—É—Ä–Ω–∞–ª–∞ –¥–ª—è —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Å–µ—Ö –¥–µ–ø–ª–æ–µ–≤ –∏ –æ—Ç–∫–∞—Ç–æ–≤ (–¥–∞—Ç–∞, –≤–µ—Ä—Å–∏—è, –≤–µ—Ç–∫–∞, –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å, —Ä–µ–∑—É–ª—å—Ç–∞—Ç)?
```
